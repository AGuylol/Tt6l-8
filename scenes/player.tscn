[gd_scene load_steps=42 format=3 uid="uid://c8tishbphs8e8"]

[ext_resource type="Texture2D" uid="uid://c0r3q5mfr0mjo" path="res://arts/characters/survivalgame-player-green.png" id="1_2pnou"]
[ext_resource type="Script" path="res://scenes/attackarea.gd" id="2_2afti"]
[ext_resource type="PackedScene" uid="uid://bcij4y6ry8na4" path="res://healthbar/healthbar.tscn" id="3_23llv"]
[ext_resource type="PackedScene" uid="uid://bh8bxuvh53ilb" path="res://staminabar/staminabar.tscn" id="4_s1jka"]

[sub_resource type="GDScript" id="GDScript_g0g3h"]
script/source = "extends CharacterBody2D

@onready var healthbar = $Healthbar

var enemy_inattack_range = false
var enemy_attack_cooldown = true

var player_health = 100.0
var player_alive = false
var attacking = false
var sword_equiped = true

var bow_equiped = false
var bow_cooldown = true
var arrow = preload(\"res://scenes/arrow.tscn\")

var max_speed = 100
var accel = 800
var friction = 400

var current_dir = \"none\"
var blend_position : Vector2 = Vector2.ZERO
var player_state 

func _ready():
	$player_animation.play(\"n-idle\")
	healthbar.init_health(player_health)

func _physics_process(delta):
	player_movement(delta)
	attack()
	enemy_attack()
	_on_attack_timeout()
	bow_shoot()
	
	if Input.is_action_just_pressed(\"equip_bow\"):
		if bow_equiped:
			bow_equiped = false
		else:
			bow_equiped = true
			
	if Input.is_action_just_pressed(\"equip_sword\"):
		if sword_equiped:
			sword_equiped = false
		else:
			sword_equiped = true
		
		
	if player_health <= 0:
		player_alive = false 
		print(\"player died\") 
		get_tree().change_scene_to_file(\"res://gameover/gameover.tscn\")
		self.queue_free()
		

		
	
func player_movement(delta):
	var input_vector = Input.get_vector(\"left\" , \"right\" , \"up\" , \"down\")
	if input_vector == Vector2.ZERO:
		player_state = \"idle\"
		apply_friction(friction * delta)
		
	else:
		player_state = \"walking\"
		apply_movement(input_vector * accel * delta)
		blend_position = input_vector
		
	move_and_slide()
	play_anim(input_vector)
	
	
func play_anim(dir):
	
	if player_state == \"idle\":
		$player_animation.play(\"s-idle\")
		
	if player_state == \"walking\":
		if dir.x == 1:
			$player_animation.play(\"e-walk\")
		elif dir.x == -1:
			$player_animation.play(\"w-walk\")
		elif dir.y == -1 :
			$player_animation.play(\"n-walk\")
		elif dir.y == 1:
			$player_animation.play(\"s-walk\")
		elif dir.x > 0.5 and dir.y > 0.5:
			$player_animation.play(\"se-walk\")
		elif dir.x < -0.5 and dir.y > 0.5:
			$player_animation.play(\"sw-walk\")
		elif dir.x > 0.5 and dir.y < -0.5:
			$player_animation.play(\"ne-walk\")
		elif dir.x < -0.5 and dir.y < -0.5:
			$player_animation.play(\"nw-walk\")
		
	
func apply_friction(amount) -> void:
	if velocity.length() > amount:
		velocity -= velocity.normalized() * amount
	else:
		velocity = Vector2.ZERO
		
func apply_movement(amount) -> void:
	velocity += amount
	velocity = velocity.limit_length(max_speed)
	
		
func attack():
	if Input.is_action_just_pressed(\"attack\"):
		attacking = true
		player_attack()
	
func player_attack():
	
	var overlapping_objects = $attackarea.get_overlapping_areas()
	
	for area in overlapping_objects:
		var parent = area.get_parent()
		print(parent.name)
		
	attacking = true
	$attack.start()


func _on_playerhitbox_body_entered(body):
	if body.has_method(\"enemy\"):
		enemy_inattack_range = true
	
	


func _on_playerhitbox_body_exited(body):
	if body.has_method(\"enemy\"):
		enemy_inattack_range = false
		
func enemy_attack():
	if enemy_inattack_range and enemy_attack_cooldown == true:
		player_health = player_health - 20
		enemy_attack_cooldown = false
		$attack_cooldown.start()
		print(player_health)
		print(\"enemy attacked you\")
		
		healthbar.health = player_health
	


func _on_attack_timeout():
	pass

func bow_shoot():
	var mouse_pos = get_global_mouse_position()
	$Marker2D.look_at(mouse_pos)
	
	if Input.is_action_just_pressed(\"bow\") and bow_equiped and bow_cooldown:
		bow_cooldown = false
		var arrow_instance = arrow.instantiate()
		arrow_instance.rotation = $Marker2D.rotation 
		arrow_instance.global_position = $Marker2D.global_position
		add_child(arrow_instance)
		
		await get_tree().create_timer(0.2).timeout
		bow_cooldown = true
		

	
"

[sub_resource type="CapsuleShape2D" id="CapsuleShape2D_hitfu"]
radius = 3.0
height = 8.0

[sub_resource type="AtlasTexture" id="AtlasTexture_thqjw"]
atlas = ExtResource("1_2pnou")
region = Rect2(0, 64, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_f27pv"]
atlas = ExtResource("1_2pnou")
region = Rect2(32, 64, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_bg51o"]
atlas = ExtResource("1_2pnou")
region = Rect2(64, 64, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_wg0rc"]
atlas = ExtResource("1_2pnou")
region = Rect2(96, 64, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_tvo2q"]
atlas = ExtResource("1_2pnou")
region = Rect2(0, 128, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_rliv1"]
atlas = ExtResource("1_2pnou")
region = Rect2(32, 128, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_iwxgr"]
atlas = ExtResource("1_2pnou")
region = Rect2(64, 128, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_1y331"]
atlas = ExtResource("1_2pnou")
region = Rect2(96, 128, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_pi8oq"]
atlas = ExtResource("1_2pnou")
region = Rect2(0, 96, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_s4r4u"]
atlas = ExtResource("1_2pnou")
region = Rect2(32, 96, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_csp3v"]
atlas = ExtResource("1_2pnou")
region = Rect2(64, 96, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_o1p80"]
atlas = ExtResource("1_2pnou")
region = Rect2(96, 96, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_gciuk"]
atlas = ExtResource("1_2pnou")
region = Rect2(0, 160, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_lsv76"]
atlas = ExtResource("1_2pnou")
region = Rect2(32, 160, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_e0ajv"]
atlas = ExtResource("1_2pnou")
region = Rect2(64, 160, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_5880n"]
atlas = ExtResource("1_2pnou")
region = Rect2(96, 160, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_4nrlj"]
atlas = ExtResource("1_2pnou")
region = Rect2(0, 0, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_krqjs"]
atlas = ExtResource("1_2pnou")
region = Rect2(32, 0, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_17mvm"]
atlas = ExtResource("1_2pnou")
region = Rect2(64, 0, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_8hfgs"]
atlas = ExtResource("1_2pnou")
region = Rect2(96, 0, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_my84a"]
atlas = ExtResource("1_2pnou")
region = Rect2(0, 32, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_2mt1y"]
atlas = ExtResource("1_2pnou")
region = Rect2(32, 32, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_e3exn"]
atlas = ExtResource("1_2pnou")
region = Rect2(64, 32, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_3b7h8"]
atlas = ExtResource("1_2pnou")
region = Rect2(96, 32, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_hkgkg"]
atlas = ExtResource("1_2pnou")
region = Rect2(0, 224, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_h0ihv"]
atlas = ExtResource("1_2pnou")
region = Rect2(32, 224, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_6f4hd"]
atlas = ExtResource("1_2pnou")
region = Rect2(64, 224, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_ci4et"]
atlas = ExtResource("1_2pnou")
region = Rect2(96, 224, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_ystdl"]
atlas = ExtResource("1_2pnou")
region = Rect2(0, 192, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_adsvh"]
atlas = ExtResource("1_2pnou")
region = Rect2(32, 192, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_81mob"]
atlas = ExtResource("1_2pnou")
region = Rect2(64, 192, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_1yyb4"]
atlas = ExtResource("1_2pnou")
region = Rect2(96, 192, 32, 32)

[sub_resource type="SpriteFrames" id="SpriteFrames_wetq0"]
animations = [{
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_thqjw")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_f27pv")
}],
"loop": true,
"name": &"e-idle",
"speed": 2.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_bg51o")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_wg0rc")
}],
"loop": true,
"name": &"e-walk",
"speed": 2.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_tvo2q")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_rliv1")
}],
"loop": true,
"name": &"n-idle",
"speed": 2.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_iwxgr")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_1y331")
}],
"loop": true,
"name": &"n-walk",
"speed": 2.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_pi8oq")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_s4r4u")
}],
"loop": true,
"name": &"ne-idle",
"speed": 2.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_csp3v")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_o1p80")
}],
"loop": true,
"name": &"ne-walk",
"speed": 2.0
}, {
"frames": [],
"loop": true,
"name": &"new_animation_3",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_gciuk")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_lsv76")
}],
"loop": true,
"name": &"nw-idle",
"speed": 2.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_e0ajv")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_5880n")
}],
"loop": true,
"name": &"nw-walk",
"speed": 2.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_4nrlj")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_krqjs")
}],
"loop": true,
"name": &"s-idle",
"speed": 2.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_17mvm")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_8hfgs")
}],
"loop": true,
"name": &"s-walk",
"speed": 2.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_my84a")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_2mt1y")
}],
"loop": true,
"name": &"se-idle",
"speed": 2.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_e3exn")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_3b7h8")
}],
"loop": true,
"name": &"se-walk",
"speed": 2.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_hkgkg")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_h0ihv")
}],
"loop": true,
"name": &"sw-idle",
"speed": 2.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_6f4hd")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_ci4et")
}],
"loop": true,
"name": &"sw-walk",
"speed": 2.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_ystdl")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_adsvh")
}],
"loop": true,
"name": &"w-idle",
"speed": 2.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_81mob")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_1yyb4")
}],
"loop": true,
"name": &"w-walk",
"speed": 2.0
}]

[sub_resource type="CapsuleShape2D" id="CapsuleShape2D_1q7mt"]
radius = 7.0
height = 14.0

[sub_resource type="CircleShape2D" id="CircleShape2D_37ron"]
radius = 4.0

[node name="player" type="CharacterBody2D"]
light_mask = 3
visibility_layer = 3
collision_layer = 3
script = SubResource("GDScript_g0g3h")

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
light_mask = 3
visibility_layer = 3
y_sort_enabled = true
position = Vector2(0, 2)
shape = SubResource("CapsuleShape2D_hitfu")

[node name="Camera2D" type="Camera2D" parent="."]
zoom = Vector2(2, 2)

[node name="player_animation" type="AnimatedSprite2D" parent="."]
scale = Vector2(1, 0.769)
sprite_frames = SubResource("SpriteFrames_wetq0")
animation = &"e-walk"

[node name="playerhitbox" type="Area2D" parent="."]

[node name="CollisionShape2D" type="CollisionShape2D" parent="playerhitbox"]
shape = SubResource("CapsuleShape2D_1q7mt")

[node name="attack_cooldown" type="Timer" parent="."]
wait_time = 0.5

[node name="attack" type="Timer" parent="."]

[node name="attackarea" type="Area2D" parent="."]
collision_layer = 2
monitorable = false
script = ExtResource("2_2afti")

[node name="CollisionShape2D" type="CollisionShape2D" parent="attackarea"]
light_mask = 2
visibility_layer = 2
position = Vector2(6, 1)
shape = SubResource("CircleShape2D_37ron")

[node name="Marker2D" type="Marker2D" parent="."]

[node name="Healthbar" parent="." instance=ExtResource("3_23llv")]
offset_left = -88.0
offset_top = -59.0
offset_right = -37.0
offset_bottom = -55.0

[node name="Staminabar" parent="." instance=ExtResource("4_s1jka")]
offset_left = -88.0
offset_top = -53.0
offset_right = -37.0
offset_bottom = -49.0

[connection signal="body_entered" from="playerhitbox" to="." method="_on_playerhitbox_body_entered"]
[connection signal="body_exited" from="playerhitbox" to="." method="_on_playerhitbox_body_exited"]
[connection signal="timeout" from="attack_cooldown" to="." method="_on_attack_cooldown_timeout"]
[connection signal="timeout" from="attack" to="." method="_on_attack_timeout"]
